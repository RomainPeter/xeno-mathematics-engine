# Makefile pour l'Orchestrateur IndustrialisÃ© (AE/CEGIS)
# Ticket: Industrialiser la pipeline Orchestrateur

.PHONY: help test demo clean install lint

help: ## Afficher l'aide
	@echo "ğŸ¯ Orchestrateur IndustrialisÃ© - Commandes disponibles:"
	@echo ""
	@grep -E '^[a-zA-Z_-]+:.*?## .*$$' $(MAKEFILE_LIST) | sort | awk 'BEGIN {FS = ":.*?## "}; {printf "  \033[36m%-15s\033[0m %s\n", $$1, $$2}'

install: ## Installer les dÃ©pendances
	@echo "ğŸ“¦ Installation des dÃ©pendances..."
	pip install -r requirements.txt
	@echo "âœ… DÃ©pendances installÃ©es"

lint: ## VÃ©rifier le code avec les linters
	@echo "ğŸ” VÃ©rification du code..."
	python -m flake8 orchestrator/ pefc/ tests/ --max-line-length=100
	python -m mypy orchestrator/ pefc/ --ignore-missing-imports
	@echo "âœ… Code vÃ©rifiÃ©"

test: ## ExÃ©cuter les tests unitaires
	@echo "ğŸ§ª ExÃ©cution des tests..."
	python -m pytest tests/ -v --tb=short
	@echo "âœ… Tests terminÃ©s"

test-next-closure: ## Tester spÃ©cifiquement Next-Closure
	@echo "ğŸ§ª Test Next-Closure..."
	python -m pytest tests/test_next_closure.py -v
	@echo "âœ… Test Next-Closure terminÃ©"

test-orchestrator: ## Tester spÃ©cifiquement l'orchestrateur
	@echo "ğŸ§ª Test Orchestrateur..."
	python -m pytest tests/test_orchestrator_integration.py -v
	@echo "âœ… Test Orchestrateur terminÃ©"

test-demo: ## Tester la dÃ©monstration
	@echo "ğŸ§ª Test de la dÃ©monstration..."
	python test_demo.py
	@echo "âœ… Test dÃ©monstration terminÃ©"

demo: ## ExÃ©cuter la dÃ©monstration complÃ¨te
	@echo "ğŸ¯ DÃ©monstration Orchestrateur IndustrialisÃ©..."
	python demo_orchestrator.py
	@echo "âœ… DÃ©monstration terminÃ©e"

demo-quick: ## DÃ©monstration rapide (timeouts courts)
	@echo "âš¡ DÃ©monstration rapide..."
	python -c "
import asyncio
from demo_orchestrator import *
from orchestrator.config import OrchestratorConfig

async def quick_demo():
    config = OrchestratorConfig(
        ae_timeout=5.0,
        cegis_propose_timeout=2.0,
        cegis_verify_timeout=3.0,
        cegis_refine_timeout=2.0,
        cegis_max_iterations=3,
        audit_dir='audit_quick'
    )
    
    llm = DemoLLMAdapter()
    verifier = DemoVerifier(success_rate=0.8)
    event_bus = StructuredEventBus()
    
    ae_engine = NextClosureEngine()
    cegis_engine = AsyncCegisEngine(llm, verifier)
    
    orchestrator = Orchestrator(
        config=config,
        ae_engine=ae_engine,
        cegis_engine=cegis_engine,
        llm_adapter=llm,
        verifier=verifier,
        event_bus=event_bus
    )
    
    domain_spec = create_demo_domain_spec()
    budgets = create_demo_budgets()
    thresholds = create_demo_thresholds()
    
    print('ğŸš€ DÃ©monstration rapide...')
    state = await orchestrator.run(domain_spec, budgets, thresholds)
    print(f'âœ… TerminÃ©: {state.phase}')

asyncio.run(quick_demo())
"
	@echo "âœ… DÃ©monstration rapide terminÃ©e"

clean: ## Nettoyer les fichiers temporaires
	@echo "ğŸ§¹ Nettoyage..."
	rm -rf audit*/
	rm -rf __pycache__/
	rm -rf .pytest_cache/
	rm -rf *.pyc
	rm -rf .mypy_cache/
	rm -f demo_orchestrator.log
	@echo "âœ… Nettoyage terminÃ©"

validate: test test-demo ## Valider l'implÃ©mentation complÃ¨te
	@echo "âœ… Validation complÃ¨te rÃ©ussie"

ci: lint test validate ## Pipeline CI complet
	@echo "âœ… Pipeline CI terminÃ©"

# Commandes de dÃ©veloppement
dev-setup: install ## Configuration pour le dÃ©veloppement
	@echo "ğŸ”§ Configuration du dÃ©veloppement..."
	pip install -e .
	@echo "âœ… Configuration terminÃ©e"

dev-test: ## Tests de dÃ©veloppement
	@echo "ğŸ§ª Tests de dÃ©veloppement..."
	python -m pytest tests/ -v --tb=short -x
	@echo "âœ… Tests de dÃ©veloppement terminÃ©s"

# Commandes de dÃ©monstration
demo-full: ## DÃ©monstration complÃ¨te avec logs
	@echo "ğŸ¯ DÃ©monstration complÃ¨te..."
	python demo_orchestrator.py 2>&1 | tee demo_full.log
	@echo "âœ… DÃ©monstration complÃ¨te terminÃ©e"

demo-audit: ## Analyser l'audit pack gÃ©nÃ©rÃ©
	@echo "ğŸ“¦ Analyse de l'audit pack..."
	@if [ -d "audit" ]; then \
		find audit -name "*.json" -exec echo "ğŸ“„ {}" \; -exec head -5 {} \; -exec echo "" \; ; \
	else \
		echo "âŒ Aucun audit pack trouvÃ©. ExÃ©cutez 'make demo' d'abord."; \
	fi
	@echo "âœ… Analyse terminÃ©e"

# Commandes de documentation
docs: ## GÃ©nÃ©rer la documentation
	@echo "ğŸ“š GÃ©nÃ©ration de la documentation..."
	@echo "ğŸ¯ Orchestrateur IndustrialisÃ© - Documentation"
	@echo "=============================================="
	@echo ""
	@echo "ğŸ“‹ Composants:"
	@echo "  - AEEngine: Next-Closure (FCA) rÃ©el"
	@echo "  - CegisEngine: Boucle CEGIS asynchrone"
	@echo "  - Orchestrator: Scheduling concurrent"
	@echo "  - EventBus: Ã‰vÃ©nements structurÃ©s"
	@echo "  - Persistence: PCAP + Incident Journal"
	@echo ""
	@echo "ğŸ”§ Utilisation:"
	@echo "  make demo          # DÃ©monstration complÃ¨te"
	@echo "  make demo-quick    # DÃ©monstration rapide"
	@echo "  make test          # Tests unitaires"
	@echo "  make validate      # Validation complÃ¨te"
	@echo ""
	@echo "ğŸ“Š RÃ©sultats attendus:"
	@echo "  - Concepts FCA gÃ©nÃ©rÃ©s"
	@echo "  - Candidats CEGIS synthÃ©tisÃ©s"
	@echo "  - Audit pack signÃ©"
	@echo "  - Ã‰vÃ©nements structurÃ©s"
	@echo "  - Journal de preuves"
	@echo "âœ… Documentation gÃ©nÃ©rÃ©e"
